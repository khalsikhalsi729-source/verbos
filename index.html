<!DOCTYPE html>
<html lang="es" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexo</title>
    <style>
    :root {
        /* --- Colors & Vars --- */
        --bg-body: #f9f9f9;
        --card-bg: #ffffff;
        --text-main: #1d1d1f;
        --text-sec: #86868b;
        --accent: #0071e3;
        --accent-soft: #e3f0ff;
        --input-bg: #f2f2f7;
        --border-color: rgba(0,0,0,0.08);
        --shadow-soft: 0 4px 20px rgba(0,0,0,0.06);
        --shadow-hover: 0 10px 30px rgba(0,0,0,0.1);
        --font-main: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
        
        /* Game Specific Colors */
        --c-chat: #007aff;    /* Blue */
        --c-lego: #ff9500;    /* Orange */
        --c-teacher: #af52de; /* Purple */
        --c-speed: #ff3b30;   /* Red */
    }

    /* Dark Mode */
    body.dark-mode {
        --bg-body: #000000;
        --card-bg: #1c1c1e;
        --text-main: #ffffff;
        --text-sec: #98989d;
        --accent: #0a84ff;
        --accent-soft: #0040dd;
        --input-bg: #2c2c2e;
        --border-color: rgba(255,255,255,0.15);
        --shadow-soft: 0 4px 20px rgba(0,0,0,0.4);
    }

    /* Universal Transition */
    * {
        transition: background-color 0.3s ease, 
                    color 0.3s ease, 
                    border-color 0.3s ease, 
                    fill 0.3s ease, 
                    box-shadow 0.3s ease;
        box-sizing: border-box; 
        margin: 0; 
        padding: 0; 
        outline: none; 
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: var(--font-main);
        background-color: var(--bg-body);
        color: var(--text-main);
        display: flex; flex-direction: column; align-items: center;
        min-height: 100vh; padding: 20px;
    }

    /* --- Header --- */
    header { width: 100%; max-width: 1000px; text-align: center; margin-bottom: 25px; position: relative; z-index: 10; }
    
    h1 { 
        font-weight: 800; font-size: 2.2rem; margin-bottom: 20px; 
        color: var(--text-main);
    }

    .header-controls {
        position: absolute; top: 0; right: 0;
        display: flex; gap: 10px;
    }

    .icon-btn {
        background: var(--card-bg); border: 1px solid var(--border-color);
        width: 44px; height: 44px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: var(--shadow-soft); color: var(--text-main);
    }
    .icon-btn svg { width: 22px; height: 22px; }

    .nav-pills { display: inline-flex; justify-content: center; gap: 8px; background: var(--card-bg); padding: 6px; border-radius: 50px; box-shadow: var(--shadow-soft); border: 1px solid var(--border-color); }
    .nav-btn { border: none; background: transparent; padding: 10px 24px; border-radius: 40px; font-weight: 600; font-size: 0.95rem; color: var(--text-sec); cursor: pointer; }
    .nav-btn.active { background: var(--text-main); color: var(--bg-body); }

    /* --- Sections --- */
    main { width: 100%; max-width: 1000px; flex: 1; }
    .section { display: none; opacity: 0; transform: translateY(10px); }
    .section.active { display: block; opacity: 1; transform: translateY(0); transition: opacity 0.4s ease, transform 0.4s ease; }

    /* --- STUDY CARDS UI --- */
    .cards-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
        gap: 20px; 
        padding-bottom: 40px; 
    }
    
    .verb-card { background: var(--card-bg); border-radius: 20px; padding: 20px; box-shadow: var(--shadow-soft); border: 1px solid var(--border-color); display: flex; flex-direction: column; }
    
    .card-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .card-header h3 { color: var(--accent); font-size: 1.6rem; }
    .card-header span { color: var(--text-sec); font-size: 0.9rem; font-style: italic; }

    .card-tabs { display: flex; gap: 5px; margin-bottom: 10px; background: var(--input-bg); padding: 4px; border-radius: 10px; }
    .tab-btn { flex: 1; border: none; background: transparent; padding: 6px; font-size: 0.8rem; font-weight: 600; color: var(--text-sec); border-radius: 8px; cursor: pointer; }
    .tab-btn.active { background: var(--card-bg); color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    .conjugation-list { list-style: none; display: none; }
    .conjugation-list.active { display: block; animation: fadeIn 0.3s; }
    .conjugation-list li { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed var(--border-color); font-size: 0.95rem; }
    .conjugation-list li:last-child { border-bottom: none; }
    .pronoun { color: var(--text-sec); font-size: 0.85em; width: 70px; }

    /* --- GAME MENU --- */
    .game-menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
    
    .game-mode-card {
        background: var(--card-bg); 
        border: 2px solid var(--border-color); /* Default Border */
        border-radius: 24px; 
        padding: 30px 20px; 
        text-align: center; 
        cursor: pointer;
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        height: 220px;
        position: relative; overflow: hidden;
        box-shadow: var(--shadow-soft);
    }

    /* STATIC STATE: Colored Bottom Border (Bonde) */
    .game-mode-card.card-chat { border-bottom: 6px solid var(--c-chat); }
    .game-mode-card.card-lego { border-bottom: 6px solid var(--c-lego); }
    .game-mode-card.card-teacher { border-bottom: 6px solid var(--c-teacher); }
    .game-mode-card.card-speed { border-bottom: 6px solid var(--c-speed); }

    /* HOVER STATE: Full Border Color */
    .game-mode-card.card-chat:hover { border-color: var(--c-chat); transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0, 122, 255, 0.15); }
    .game-mode-card.card-lego:hover { border-color: var(--c-lego); transform: translateY(-4px); box-shadow: 0 10px 30px rgba(255, 149, 0, 0.15); }
    .game-mode-card.card-teacher:hover { border-color: var(--c-teacher); transform: translateY(-4px); box-shadow: 0 10px 30px rgba(175, 82, 222, 0.15); }
    .game-mode-card.card-speed:hover { border-color: var(--c-speed); transform: translateY(-4px); box-shadow: 0 10px 30px rgba(255, 59, 48, 0.15); }

    .mode-icon { font-size: 3.5rem; margin-bottom: 15px; }
    .mode-title { font-weight: 700; font-size: 1.2rem; color: var(--text-main); margin-bottom: 5px; }
    .mode-desc { font-size: 0.85rem; color: var(--text-sec); line-height: 1.4; }

    /* --- GAME VIEWPORT --- */
    .game-viewport {
        background: var(--card-bg); border-radius: 24px; box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-color); min-height: 550px;
        position: relative; overflow: hidden; display: flex; flex-direction: column;
    }
    .game-header-bar {
        padding: 15px 20px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center; background: var(--input-bg);
    }
    .back-btn { background: none; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; color: var(--text-main); display: flex; align-items: center; gap: 5px; }
    .game-content { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; position: relative; }

    .game-input-area { width: 100%; padding: 20px; border-top: 1px solid var(--border-color); background: var(--card-bg); z-index: 20; }
    .game-input { width: 100%; padding: 16px; border-radius: 16px; border: 2px solid var(--border-color); background: var(--input-bg); font-size: 1.1rem; text-align: center; color: var(--text-main); }
    .game-input:focus { border-color: var(--accent); background: var(--card-bg); }
    .btn-submit { width: 100%; padding: 16px; background: var(--text-main); color: var(--bg-body); border: none; border-radius: 16px; margin-top: 12px; font-weight: 700; cursor: pointer; font-size: 1rem; }
    .btn-submit:active { transform: scale(0.98); }

    /* --- SPECIFIC GAME STYLES --- */
    /* Chat */
    .chat-wrapper { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; }
    .chat-bubble { padding: 15px 20px; border-radius: 20px; max-width: 85%; line-height: 1.5; font-size: 1.05rem; position: relative; animation: slideIn 0.3s; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .bot-bubble { background: var(--input-bg); color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 4px; }
    .user-bubble { background: var(--c-chat); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-meta { font-size: 0.75rem; color: var(--text-sec); margin-top: 5px; font-weight: bold; text-transform: uppercase; }

    /* Lego */
    .lego-pronoun { font-size: 2.5rem; font-weight: 900; color: var(--text-main); margin-bottom: 20px; text-align: center; }
    .lego-workspace { background: var(--input-bg); padding: 30px; border-radius: 20px; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .lego-stem { font-size: 1.4rem; font-weight: 800; color: var(--text-sec); padding: 10px 15px; background: var(--card-bg); border-radius: 10px; border: 2px solid var(--border-color); }
    .lego-dropzone { width: 100px; height: 50px; border: 2px dashed var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--accent); font-weight: bold; background: rgba(0,0,0,0.02); }
    .lego-dropzone.filled { background: var(--c-lego); color: white; border: none; }
    .lego-pieces { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .lego-piece { padding: 12px 24px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.1); font-size: 1.1rem; }
    .lego-piece:active { transform: translateY(4px); box-shadow: none; }

    /* Teacher */
    .teacher-card {
        background: #fff9c4; /* Yellow sticky note */
        color: #5d4037;
        width: 100%; max-width: 450px; padding: 40px 30px; 
        border-radius: 2px;
        transform: rotate(-1deg);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        text-align: center; 
        font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
        position: relative;
        margin: 0 auto;
    }
    .teacher-card::before {
        content: '';
        position: absolute;
        top: -15px; left: 50%; transform: translateX(-50%);
        width: 130px; height: 35px;
        background: rgba(255, 255, 255, 0.4);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        backdrop-filter: blur(2px);
    }
    .teacher-header { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 25px; }
    .teacher-label { color: #8d6e63; font-size: 0.9rem; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
    .teacher-mistake { font-size: 1.4rem; margin-bottom: 25px; line-height: 1.4; color: #5d4037; }
    .error-highlight { text-decoration: line-through; color: #c62828; font-family: 'Courier New', monospace; font-weight: bold; }
    .teacher-prompt { color: #9e9d24; font-weight: bold; font-size: 1rem; }
    
    /* Speed */
    .speed-track { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .falling-item {
        position: absolute; left: 50%; transform: translateX(-50%);
        background: var(--card-bg); padding: 12px 25px; border-radius: 30px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.15); border: 2px solid var(--c-speed);
        text-align: center; z-index: 5;
    }
    .ground-line { position: absolute; bottom: 0; width: 100%; height: 6px; background: var(--c-speed); }

    /* Toast */
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #34c759; color: white; padding: 12px 30px; border-radius: 50px; font-weight: bold; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.error { background: #ff3b30; }

    /* AUTH OVERLAY */
    #auth-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-body); z-index: 9999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px;
    }
    .auth-box {
        background: var(--card-bg); padding: 30px; border-radius: 20px;
        box-shadow: var(--shadow-hover); border: 1px solid var(--border-color);
        width: 100%; max-width: 320px; text-align: center;
    }
    .auth-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 20px; color: var(--text-main); }

    /* ADD VERB MODAL */
    #add-verb-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 2000;
        backdrop-filter: blur(5px);
        display: none; align-items: center; justify-content: center;
        padding: 20px;
    }
    .modal-content {
        background: var(--card-bg); width: 100%; max-width: 600px;
        max-height: 90vh; overflow-y: auto;
        border-radius: 24px; padding: 25px;
        box-shadow: var(--shadow-hover);
        border: 1px solid var(--border-color);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 1.4rem; font-weight: 700; color: var(--text-main); }
    .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec); }
    
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 600; color: var(--text-sec); }
    .form-input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-main); }
    
    .form-grid-6 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
    .form-section-title { font-size: 1rem; color: var(--accent); font-weight: bold; margin: 15px 0 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- AUTH OVERLAY -->
    <div id="auth-overlay">
        <div class="auth-box">
            <h2 class="auth-title">üîê Acceso</h2>
            <p style="color:var(--text-sec); margin-bottom:15px">Introduce el c√≥digo de acceso</p>
            <input type="password" id="auth-pass" class="game-input" placeholder="Passcode" style="margin-bottom:15px">
            <button class="btn-submit" onclick="checkAuth()">Entrar</button>
            <p id="auth-error" style="color:red; font-size:0.9rem; margin-top:10px; display:none">C√≥digo incorrecto</p>
        </div>
    </div>

    <!-- ADD VERB MODAL -->
    <div id="add-verb-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">A√±adir Nuevo Verbo</span>
                <button class="close-modal" onclick="closeAddModal()">√ó</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Infinitivo (ej. Cantar)</label>
                <input type="text" id="new-infinitive" class="form-input" placeholder="Cantar">
            </div>
            <div class="form-group">
                <label class="form-label">Traducci√≥n (ej. To sing)</label>
                <input type="text" id="new-trans" class="form-input" placeholder="To sing">
            </div>

            <div id="conjugation-forms">
                <!-- Javascript will generate inputs here -->
            </div>

            <button class="btn-submit" onclick="saveNewVerb()">Guardar Verbo</button>
        </div>
    </div>

    <div id="toast" class="toast">¬°Correcto!</div>

    <header>
        <div class="header-controls">
            <!-- Add Verb Button -->
            <button class="icon-btn" onclick="openAddModal()" aria-label="Add Verb">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
            
            <!-- Theme Toggle -->
            <button class="icon-btn" onclick="toggleTheme()" aria-label="Toggle Dark Mode">
                <svg id="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg>
            </button>
        </div>

        <h1>Nexo</h1>
        
        <nav class="nav-pills">
            <button class="nav-btn active" onclick="showSection('study')" id="nav-study">Verbos</button>
            <button class="nav-btn" onclick="showSection('quiz')" id="nav-quiz">Game Arena</button>
        </nav>
    </header>

    <main>
        <div id="section-study" class="section active">
            <input type="text" id="search-bar" placeholder="Buscar verbo (e.g. Tener)..." 
                   style="width:100%; padding:15px; border-radius:15px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-main); margin-bottom:20px; font-size:1rem;" 
                   onkeyup="renderCards()">
            
            <div class="cards-grid" id="cards-container">
                </div>
        </div>

        <div id="section-quiz" class="section">
            
            <div id="game-menu" class="game-menu-grid">
                
                <div class="game-mode-card card-chat" onclick="launchGame('chat')">
                    <div class="mode-icon" style="color:var(--c-chat)">üí¨</div>
                    <div class="mode-title">Chat Simulator</div>
                    <div class="mode-desc">Contexto real.<br>Conversaci√≥n.</div>
                </div>
                
                <div class="game-mode-card card-lego" onclick="launchGame('lego')">
                    <div class="mode-icon" style="color:var(--c-lego)">üß©</div>
                    <div class="mode-title">Verb Lego</div>
                    <div class="mode-desc">Construye el verbo.<br>Estructura.</div>
                </div>
                
                <div class="game-mode-card card-teacher" onclick="launchGame('teacher')">
                    <div class="mode-icon" style="color:var(--c-teacher)">üë®‚Äçüè´</div>
                    <div class="mode-title">Be the Teacher</div>
                    <div class="mode-desc">Corrige los errores.<br>L√≥gica.</div>
                </div>
                
                <div class="game-mode-card card-speed" onclick="launchGame('speed')">
                    <div class="mode-icon" style="color:var(--c-speed)">‚ö°</div>
                    <div class="mode-title">Falling Words</div>
                    <div class="mode-desc">Escribe r√°pido.<br>Velocidad.</div>
                </div>
            </div>

            <div id="game-viewport" class="game-viewport" style="display:none;">
                <div class="game-header-bar">
                    <button class="back-btn" onclick="exitGame()">
                        <span>‚ùÆ Salir</span>
                    </button>
                    <span id="game-title" style="font-weight:800; text-transform:uppercase; letter-spacing:1px; font-size:0.85rem">GAME</span>
                    <span style="font-weight:bold; color:var(--text-main)">Puntos: <span id="score" style="color:var(--accent)">0</span></span>
                </div>

                <div id="game-content" class="game-content">
                    </div>

                <div id="game-controls" class="game-input-area">
                    <input type="text" id="user-input" class="game-input" placeholder="Escribe aqu√≠..." autocomplete="off">
                    <button class="btn-submit" onclick="checkAnswer()">Enviar</button>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- 1. DATA (SPANISH ONLY) ---
        const pronouns = ["Yo", "T√∫", "√âl/Ella", "Nosotros", "Vosotros", "Ellos"];
        
        // Using 'const' for the array reference, but we can push new items into it
        const verbsData = [
            // 1-10
            { infinitive: "Ser", translation: "To be (perm)", presente: ["soy", "eres", "es", "somos", "sois", "son"], perfecto: ["he sido", "has sido", "ha sido", "hemos sido", "hab√©is sido", "han sido"], indefinido: ["fui", "fuiste", "fue", "fuimos", "fuisteis", "fueron"] },
            { infinitive: "Estar", translation: "To be (temp)", presente: ["estoy", "est√°s", "est√°", "estamos", "est√°is", "est√°n"], perfecto: ["he estado", "has estado", "ha estado", "hemos estado", "hab√©is estado", "han estado"], indefinido: ["estuve", "estuviste", "estuvo", "estuvimos", "estuvisteis", "estuvieron"] },
            { infinitive: "Tener", translation: "To have", presente: ["tengo", "tienes", "tiene", "tenemos", "ten√©is", "tienen"], perfecto: ["he tenido", "has tenido", "ha tenido", "hemos tenido", "hab√©is tenido", "han tenido"], indefinido: ["tuve", "tuviste", "tuvo", "tuvimos", "tuvisteis", "tuvieron"] },
            { infinitive: "Ir", translation: "To go", presente: ["voy", "vas", "va", "vamos", "vais", "van"], perfecto: ["he ido", "has ido", "ha ido", "hemos ido", "hab√©is ido", "han ido"], indefinido: ["fui", "fuiste", "fue", "fuimos", "fuisteis", "fueron"] },
            { infinitive: "Hacer", translation: "To do/make", presente: ["hago", "haces", "hace", "hacemos", "hac√©is", "hacen"], perfecto: ["he hecho", "has hecho", "ha hecho", "hemos hecho", "hab√©is hecho", "han hecho"], indefinido: ["hice", "hiciste", "hizo", "hicimos", "hicisteis", "hicieron"] },
            { infinitive: "Poder", translation: "To can", presente: ["puedo", "puedes", "puede", "podemos", "pod√©is", "pueden"], perfecto: ["he podido", "has podido", "ha podido", "hemos podido", "hab√©is podido", "han podido"], indefinido: ["pude", "pudiste", "pudo", "pudimos", "pudisteis", "pudieron"] },
            { infinitive: "Decir", translation: "To say", presente: ["digo", "dices", "dice", "decimos", "dec√≠s", "dicen"], perfecto: ["he dicho", "has dicho", "ha dicho", "hemos dicho", "hab√©is dicho", "han dicho"], indefinido: ["dije", "dijiste", "dijo", "dijimos", "dijisteis", "dijeron"] },
            { infinitive: "Ver", translation: "To see", presente: ["veo", "ves", "ve", "vemos", "veis", "ven"], perfecto: ["he visto", "has visto", "ha visto", "hemos visto", "hab√©is visto", "han visto"], indefinido: ["vi", "viste", "vio", "vimos", "visteis", "vieron"] },
            { infinitive: "Comer", translation: "To eat", presente: ["como", "comes", "come", "comemos", "com√©is", "comen"], perfecto: ["he comido", "has comido", "ha comido", "hemos comido", "hab√©is comido", "han comido"], indefinido: ["com√≠", "comiste", "comi√≥", "comimos", "comisteis", "comieron"] },
            { infinitive: "Tomar", translation: "To take/drink", presente: ["tomo", "tomas", "toma", "tomamos", "tom√°is", "toman"], perfecto: ["he tomado", "has tomado", "ha tomado", "hemos tomado", "hab√©is tomado", "han tomado"], indefinido: ["tom√©", "tomaste", "tom√≥", "tomamos", "tomasteis", "tomaron"] },
            // 11-20
            { infinitive: "Querer", translation: "To want", presente: ["quiero", "quieres", "quiere", "queremos", "quer√©is", "quieren"], perfecto: ["he querido", "has querido", "ha querido", "hemos querido", "hab√©is querido", "han querido"], indefinido: ["quise", "quisiste", "quiso", "quisimos", "quisisteis", "quisieron"] },
            { infinitive: "Saber", translation: "To know (info)", presente: ["s√©", "sabes", "sabe", "sabemos", "sab√©is", "saben"], perfecto: ["he sabido", "has sabido", "ha sabido", "hemos sabido", "hab√©is sabido", "han sabido"], indefinido: ["supe", "supiste", "supo", "supimos", "supisteis", "supieron"] },
            { infinitive: "Venir", translation: "To come", presente: ["vengo", "vienes", "viene", "venimos", "ven√≠s", "vienen"], perfecto: ["he venido", "has venido", "ha venido", "hemos venido", "hab√©is venido", "han venido"], indefinido: ["vine", "viniste", "vino", "vinimos", "vinisteis", "vinieron"] },
            { infinitive: "Poner", translation: "To put", presente: ["pongo", "pones", "pone", "ponemos", "pon√©is", "ponen"], perfecto: ["he puesto", "has puesto", "ha puesto", "hemos puesto", "hab√©is puesto", "han puesto"], indefinido: ["puse", "pusiste", "puso", "pusimos", "pusisteis", "pusieron"] },
            { infinitive: "Dar", translation: "To give", presente: ["doy", "das", "da", "damos", "dais", "dan"], perfecto: ["he dado", "has dado", "ha dado", "hemos dado", "hab√©is dado", "han dado"], indefinido: ["di", "diste", "dio", "dimos", "disteis", "dieron"] },
            { infinitive: "Llegar", translation: "To arrive", presente: ["llego", "llegas", "llega", "llegamos", "lleg√°is", "llegan"], perfecto: ["he llegado", "has llegado", "ha llegado", "hemos llegado", "hab√©is llegado", "han llegado"], indefinido: ["llegu√©", "llegaste", "lleg√≥", "llegamos", "llegasteis", "llegaron"] },
            { infinitive: "Pasar", translation: "To pass/happen", presente: ["paso", "pasas", "pasa", "pasamos", "pas√°is", "pasan"], perfecto: ["he pasado", "has pasado", "ha pasado", "hemos pasado", "hab√©is pasado", "han pasado"], indefinido: ["pas√©", "pasaste", "pas√≥", "pasamos", "pasasteis", "pasaron"] },
            { infinitive: "Deber", translation: "To must/owe", presente: ["debo", "debes", "debe", "debemos", "deb√©is", "deben"], perfecto: ["he debido", "has debido", "ha debido", "hemos debido", "hab√©is debido", "han debido"], indefinido: ["deb√≠", "debiste", "debi√≥", "debimos", "debisteis", "debieron"] },
            { infinitive: "Quedar", translation: "To stay/meet", presente: ["quedo", "quedas", "queda", "quedamos", "qued√°is", "quedan"], perfecto: ["he quedado", "has quedado", "ha quedado", "hemos quedado", "hab√©is quedado", "han quedado"], indefinido: ["qued√©", "quedaste", "qued√≥", "quedamos", "quedasteis", "quedaron"] },
            { infinitive: "Creer", translation: "To believe", presente: ["creo", "crees", "cree", "creemos", "cre√©is", "creen"], perfecto: ["he cre√≠do", "has cre√≠do", "ha cre√≠do", "hemos cre√≠do", "hab√©is cre√≠do", "han cre√≠do"], indefinido: ["cre√≠", "cre√≠ste", "crey√≥", "cre√≠mos", "cre√≠steis", "creyeron"] },
            // 21-30
            { infinitive: "Hablar", translation: "To speak", presente: ["hablo", "hablas", "habla", "hablamos", "habl√°is", "hablan"], perfecto: ["he hablado", "has hablado", "ha hablado", "hemos hablado", "hab√©is hablado", "han hablado"], indefinido: ["habl√©", "hablaste", "habl√≥", "hablamos", "hablasteis", "hablaron"] },
            { infinitive: "Llevar", translation: "To carry/wear", presente: ["llevo", "llevas", "lleva", "llevamos", "llev√°is", "llevan"], perfecto: ["he llevado", "has llevado", "ha llevado", "hemos llevado", "hab√©is llevado", "han llevado"], indefinido: ["llev√©", "llevaste", "llev√≥", "llevamos", "llevasteis", "llevaron"] },
            { infinitive: "Dejar", translation: "To leave/let", presente: ["dejo", "dejas", "deja", "dejamos", "dej√°is", "dejan"], perfecto: ["he dejado", "has dejado", "ha dejado", "hemos dejado", "hab√©is dejado", "han dejado"], indefinido: ["dej√©", "dejaste", "dej√≥", "dejamos", "dejasteis", "dejaron"] },
            { infinitive: "Seguir", translation: "To follow", presente: ["sigo", "sigues", "sigue", "seguimos", "segu√≠s", "siguen"], perfecto: ["he seguido", "has seguido", "ha seguido", "hemos seguido", "hab√©is seguido", "han seguido"], indefinido: ["segu√≠", "seguiste", "sigui√≥", "seguimos", "seguisteis", "siguieron"] },
            { infinitive: "Encontrar", translation: "To find", presente: ["encuentro", "encuentras", "encuentra", "encontramos", "encontr√°is", "encuentran"], perfecto: ["he encontrado", "has encontrado", "ha encontrado", "hemos encontrado", "hab√©is encontrado", "han encontrado"], indefinido: ["encontr√©", "encontraste", "encontr√≥", "encontramos", "encontrasteis", "encontraron"] },
            { infinitive: "Llamar", translation: "To call", presente: ["llamo", "llamas", "llama", "llamamos", "llam√°is", "llaman"], perfecto: ["he llamado", "has llamado", "ha llamado", "hemos llamado", "hab√©is llamado", "han llamado"], indefinido: ["llam√©", "llamaste", "llam√≥", "llamamos", "llamasteis", "llamaron"] },
            { infinitive: "Vivir", translation: "To live", presente: ["vivo", "vives", "vive", "vivimos", "viv√≠s", "viven"], perfecto: ["he vivido", "has vivido", "ha vivido", "hemos vivido", "hab√©is vivido", "han vivido"], indefinido: ["viv√≠", "viviste", "vivi√≥", "vivimos", "vivisteis", "vivieron"] },
            { infinitive: "Escuchar", translation: "To listen", presente: ["escucho", "escuchas", "escucha", "escuchamos", "escuch√°is", "escuchan"], perfecto: ["he escuchado", "has escuchado", "ha escuchado", "hemos escuchado", "hab√©is escuchado", "han escuchado"], indefinido: ["escuch√©", "escuchaste", "escuch√≥", "escuchamos", "escuchasteis", "escucharon"] },
            { infinitive: "Mirar", translation: "To look", presente: ["miro", "miras", "mira", "miramos", "mir√°is", "miran"], perfecto: ["he mirado", "has mirado", "ha mirado", "hemos mirado", "hab√©is mirado", "han mirado"], indefinido: ["mir√©", "miraste", "mir√≥", "miramos", "mirasteis", "miraron"] },
            { infinitive: "Jugar", translation: "To play", presente: ["juego", "juegas", "juega", "jugamos", "jug√°is", "juegan"], perfecto: ["he jugado", "has jugado", "ha jugado", "hemos jugado", "hab√©is jugado", "han jugado"], indefinido: ["jugu√©", "jugaste", "jug√≥", "jugamos", "jugasteis", "jugaron"] },
            // 31-40
            { infinitive: "Empezar", translation: "To start", presente: ["empiezo", "empiezas", "empieza", "empezamos", "empez√°is", "empiezan"], perfecto: ["he empezado", "has empezado", "ha empezado", "hemos empezado", "hab√©is empezado", "han empezado"], indefinido: ["empec√©", "empezaste", "empez√≥", "empezamos", "empezasteis", "empezaron"] },
            { infinitive: "Buscar", translation: "To search", presente: ["busco", "buscas", "busca", "buscamos", "busc√°is", "buscan"], perfecto: ["he buscado", "has buscado", "ha buscado", "hemos buscado", "hab√©is buscado", "han buscado"], indefinido: ["busqu√©", "buscaste", "busc√≥", "buscamos", "buscasteis", "buscaron"] },
            { infinitive: "Escribir", translation: "To write", presente: ["escribo", "escribes", "escribe", "escribimos", "escrib√≠s", "escriben"], perfecto: ["he escrito", "has escrito", "ha escrito", "hemos escrito", "hab√©is escrito", "han escrito"], indefinido: ["escrib√≠", "escribiste", "escribi√≥", "escribimos", "escribisteis", "escribieron"] },
            { infinitive: "Leer", translation: "To read", presente: ["leo", "lees", "lee", "leemos", "le√©is", "leen"], perfecto: ["he le√≠do", "has le√≠do", "ha le√≠do", "hemos le√≠do", "hab√©is le√≠do", "han le√≠do"], indefinido: ["le√≠", "le√≠ste", "ley√≥", "le√≠mos", "le√≠steis", "leyeron"] },
            { infinitive: "Caer", translation: "To fall", presente: ["caigo", "caes", "cae", "caemos", "ca√©is", "caen"], perfecto: ["he ca√≠do", "has ca√≠do", "ha ca√≠do", "hemos ca√≠do", "hab√©is ca√≠do", "han ca√≠do"], indefinido: ["ca√≠", "ca√≠ste", "cay√≥", "ca√≠mos", "ca√≠steis", "cayeron"] },
            { infinitive: "Dormir", translation: "To sleep", presente: ["duermo", "duermes", "duerme", "dormimos", "dorm√≠s", "duermen"], perfecto: ["he dormido", "has dormido", "ha dormido", "hemos dormido", "hab√©is dormido", "han dormido"], indefinido: ["dorm√≠", "dormiste", "durmi√≥", "dormimos", "dormisteis", "durmieron"] },
            { infinitive: "Entender", translation: "To understand", presente: ["entiendo", "entiendes", "entiende", "entendemos", "entend√©is", "entienden"], perfecto: ["he entendido", "has entendido", "ha entendido", "hemos entendido", "hab√©is entendido", "han entendido"], indefinido: ["entend√≠", "entendiste", "entendi√≥", "entendimos", "entendisteis", "entendieron"] },
            { infinitive: "Pedir", translation: "To ask for", presente: ["pido", "pides", "pide", "pedimos", "ped√≠s", "piden"], perfecto: ["he pedido", "has pedido", "ha pedido", "hemos pedido", "hab√©is pedido", "han pedido"], indefinido: ["ped√≠", "pediste", "pidi√≥", "pedimos", "pedisteis", "pidieron"] },
            { infinitive: "Pensar", translation: "To think", presente: ["pienso", "piensas", "piensa", "pensamos", "pens√°is", "piensan"], perfecto: ["he pensado", "has pensado", "ha pensado", "hemos pensado", "hab√©is pensado", "han pensado"], indefinido: ["pens√©", "pensaste", "pens√≥", "pensamos", "pensasteis", "pensaron"] },
            { infinitive: "Perder", translation: "To lose", presente: ["pierdo", "pierdes", "pierde", "perdemos", "perd√©is", "pierden"], perfecto: ["he perdido", "has perdido", "ha perdido", "hemos perdido", "hab√©is perdido", "han perdido"], indefinido: ["perd√≠", "perdiste", "perdi√≥", "perdimos", "perdisteis", "perdieron"] },
            // 41-50
            { infinitive: "Preferir", translation: "To prefer", presente: ["prefiero", "prefieres", "prefiere", "preferimos", "prefer√≠s", "prefieren"], perfecto: ["he preferido", "has preferido", "ha preferido", "hemos preferido", "hab√©is preferido", "han preferido"], indefinido: ["prefer√≠", "preferiste", "prefiri√≥", "preferimos", "preferisteis", "prefirieron"] },
            { infinitive: "Sentir", translation: "To feel", presente: ["siento", "sientes", "siente", "sentimos", "sent√≠s", "sienten"], perfecto: ["he sentido", "has sentido", "ha sentido", "hemos sentido", "hab√©is sentido", "han sentido"], indefinido: ["sent√≠", "sentiste", "sinti√≥", "sentimos", "sentisteis", "sintieron"] },
            { infinitive: "Traer", translation: "To bring", presente: ["traigo", "traes", "trae", "traemos", "tra√©is", "traen"], perfecto: ["he tra√≠do", "has tra√≠do", "ha tra√≠do", "hemos tra√≠do", "hab√©is tra√≠do", "han tra√≠do"], indefinido: ["traje", "trajiste", "trajo", "trajimos", "trajisteis", "trajeron"] },
            { infinitive: "Volver", translation: "To return", presente: ["vuelvo", "vuelves", "vuelve", "volvemos", "volv√©is", "vuelven"], perfecto: ["he vuelto", "has vuelto", "ha vuelto", "hemos vuelto", "hab√©is vuelto", "han vuelto"], indefinido: ["volv√≠", "volviste", "volvi√≥", "volvimos", "volvisteis", "volvieron"] },
            { infinitive: "Conocer", translation: "To know (people)", presente: ["conozco", "conoces", "conoce", "conocemos", "conoc√©is", "conocen"], perfecto: ["he conocido", "has conocido", "ha conocido", "hemos conocido", "hab√©is conocido", "han conocido"], indefinido: ["conoc√≠", "conociste", "conoci√≥", "conocimos", "conocisteis", "conocieron"] },
            { infinitive: "Salir", translation: "To go out", presente: ["salgo", "sales", "sale", "salimos", "sal√≠s", "salen"], perfecto: ["he salido", "has salido", "ha salido", "hemos salido", "hab√©is salido", "han salido"], indefinido: ["sal√≠", "saliste", "sali√≥", "salimos", "salisteis", "salieron"] },
            { infinitive: "Abrir", translation: "To open", presente: ["abro", "abres", "abre", "abrimos", "abr√≠s", "abren"], perfecto: ["he abierto", "has abierto", "ha abierto", "hemos abierto", "hab√©is abierto", "han abierto"], indefinido: ["abr√≠", "abriste", "abri√≥", "abrimos", "abristeis", "abrieron"] },
            { infinitive: "Cerrar", translation: "To close", presente: ["cierro", "cierras", "cierra", "cerramos", "cerr√°is", "cierran"], perfecto: ["he cerrado", "has cerrado", "ha cerrado", "hemos cerrado", "hab√©is cerrado", "han cerrado"], indefinido: ["cerr√©", "cerraste", "cerr√≥", "cerramos", "cerrasteis", "cerraron"] },
            { infinitive: "Comprar", translation: "To buy", presente: ["compro", "compras", "compra", "compramos", "compr√°is", "compran"], perfecto: ["he comprado", "has comprado", "ha comprado", "hemos comprado", "hab√©is comprado", "han comprado"], indefinido: ["compr√©", "compraste", "compr√≥", "compramos", "comprasteis", "compraron"] },
            { infinitive: "Viajar", translation: "To travel", presente: ["viajo", "viajas", "viaja", "viajamos", "viaj√°is", "viajan"], perfecto: ["he viajado", "has viajado", "ha viajado", "hemos viajado", "hab√©is viajado", "han viajado"], indefinido: ["viaj√©", "viajaste", "viaj√≥", "viajamos", "viajasteis", "viajaron"] },
            // 51-55
            { infinitive: "Beber", translation: "To drink", presente: ["bebo", "bebes", "bebe", "bebemos", "beb√©is", "beben"], perfecto: ["he bebido", "has bebido", "ha bebido", "hemos bebido", "hab√©is bebido", "han bebido"], indefinido: ["beb√≠", "bebiste", "bebi√≥", "bebimos", "bebisteis", "bebieron"] },
            { infinitive: "Caminar", translation: "To walk", presente: ["camino", "caminas", "camina", "caminamos", "camin√°is", "caminan"], perfecto: ["he caminado", "has caminado", "ha caminado", "hemos caminado", "hab√©is caminado", "han caminado"], indefinido: ["camin√©", "caminaste", "camin√≥", "caminamos", "caminasteis", "caminaron"] },
            { infinitive: "Cocinar", translation: "To cook", presente: ["cocino", "cocinas", "cocina", "cocinamos", "cocin√°is", "cocinan"], perfecto: ["he cocinado", "has cocinado", "ha cocinado", "hemos cocinado", "hab√©is cocinado", "han cocinado"], indefinido: ["cocin√©", "cocinaste", "cocin√≥", "cocinamos", "cocinasteis", "cocinaron"] },
            { infinitive: "Usar", translation: "To use", presente: ["uso", "usas", "usa", "usamos", "us√°is", "usan"], perfecto: ["he usado", "has usado", "ha usado", "hemos usado", "hab√©is usado", "han usado"], indefinido: ["us√©", "usaste", "us√≥", "usamos", "usasteis", "usaron"] },
            { infinitive: "Gustar", translation: "To like", presente: ["Me gusta", "Te gusta", "Le gusta", "Nos gusta", "Os gusta", "Les gusta"], perfecto: ["Me ha gustado", "Te ha gustado", "Le ha gustado", "Nos ha gustado", "Os ha gustado", "Les han gustado"], indefinido: ["Me gust√≥", "Te gust√≥", "Le gust√≥", "Nos gust√≥", "Os gust√≥", "Les gust√≥"] },

  { infinitive: "Haber", translation: "To have / To exist", presente: ["he", "has", "ha", "hemos", "hab√©is", "han"], perfecto: ["he habido", "has habido", "ha habido", "hemos habido", "hab√©is habido", "han habido"], indefinido: ["hube", "hubiste", "hubo", "hubimos", "hubisteis", "hubieron"] },

  { infinitive: "Parecer", translation: "To seem", presente: ["parezco", "pareces", "parece", "parecemos", "parec√©is", "parecen"], perfecto: ["he parecido", "has parecido", "ha parecido", "hemos parecido", "hab√©is parecido", "han parecido"], indefinido: ["parec√≠", "pareciste", "pareci√≥", "parecimos", "parecisteis", "parecieron"] },

  { infinitive: "Soler", translation: "To usually do / To tend to", presente: ["suelo", "sueles", "suele", "solemos", "sol√©is", "suelen"], perfecto: ["he solido", "has solido", "ha solido", "hemos solido", "hab√©is solido", "han solido"], indefinido: ["sol√≠", "soliste", "soli√≥", "solimos", "solisteis", "solieron"] },

  { infinitive: "Traducir", translation: "To translate", presente: ["traduzco", "traduces", "traduce", "traducimos", "traduc√≠s", "traducen"], perfecto: ["he traducido", "has traducido", "ha traducido", "hemos traducido", "hab√©is traducido", "han traducido"], indefinido: ["traduje", "tradujiste", "tradujo", "tradujimos", "tradujisteis", "tradujeron"] },

  { infinitive: "Producir", translation: "To produce", presente: ["produzco", "produces", "produce", "producimos", "produc√≠s", "producen"], perfecto: ["he producido", "has producido", "ha producido", "hemos producido", "hab√©is producido", "han producido"], indefinido: ["produje", "produjiste", "produjo", "produjimos", "produjisteis", "produjeron"] },

  { infinitive: "Conducir", translation: "To drive / To lead", presente: ["conduzco", "conduces", "conduce", "conducimos", "conduc√≠s", "conducen"], perfecto: ["he conducido", "has conducido", "ha conducido", "hemos conducido", "hab√©is conducido", "han conducido"], indefinido: ["conduje", "condujiste", "condujo", "condujimos", "condujisteis", "condujeron"] },

  { infinitive: "O√≠r", translation: "To hear", presente: ["oigo", "oyes", "oye", "o√≠mos", "o√≠s", "oyen"], perfecto: ["he o√≠do", "has o√≠do", "ha o√≠do", "hemos o√≠do", "hab√©is o√≠do", "han o√≠do"], indefinido: ["o√≠", "o√≠ste", "oy√≥", "o√≠mos", "o√≠steis", "oyeron"] },

  { infinitive: "Morir", translation: "To die", presente: ["muero", "mueres", "muere", "morimos", "mor√≠s", "mueren"], perfecto: ["he muerto", "has muerto", "ha muerto", "hemos muerto", "hab√©is muerto", "han muerto"], indefinido: ["mor√≠", "moriste", "muri√≥", "morimos", "moristeis", "murieron"] },

  { infinitive: "Costar", translation: "To cost", presente: ["cuesto", "cuestas", "cuesta", "costamos", "cost√°is", "cuestan"], perfecto: ["he costado", "has costado", "ha costado", "hemos costado", "hab√©is costado", "han costado"], indefinido: ["cost√©", "costaste", "cost√≥", "costamos", "costasteis", "costaron"] },

  { infinitive: "Sentirse", translation: "To feel", presente: ["me siento", "te sientes", "se siente", "nos sentimos", "os sent√≠s", "se sienten"], perfecto: ["me he sentido", "te has sentido", "se ha sentido", "nos hemos sentido", "os hab√©is sentido", "se han sentido"], indefinido: ["me sent√≠", "te sentiste", "se sinti√≥", "nos sentimos", "os sentisteis", "se sintieron"] },

  { infinitive: "Preguntar", translation: "To ask", presente: ["pregunto", "preguntas", "pregunta", "preguntamos", "pregunt√°is", "preguntan"], perfecto: ["he preguntado", "has preguntado", "ha preguntado", "hemos preguntado", "hab√©is preguntado", "han preguntado"], indefinido: ["pregunt√©", "preguntaste", "pregunt√≥", "preguntamos", "preguntasteis", "preguntaron"] },

  { infinitive: "Recordar", translation: "To remember", presente: ["recuerdo", "recuerdas", "recuerda", "recordamos", "record√°is", "recuerdan"], perfecto: ["he recordado", "has recordado", "ha recordado", "hemos recordado", "hab√©is recordado", "han recordado"], indefinido: ["record√©", "recordaste", "record√≥", "recordamos", "recordasteis", "recordaron"] },

  { infinitive: "Darse cuenta (de)", translation: "To realize", presente: ["me doy cuenta", "te das cuenta", "se da cuenta", "nos damos cuenta", "os dais cuenta", "se dan cuenta"], perfecto: ["me he dado cuenta", "te has dado cuenta", "se ha dado cuenta", "nos hemos dado cuenta", "os hab√©is dado cuenta", "se han dado cuenta"], indefinido: ["me di cuenta", "te diste cuenta", "se dio cuenta", "nos dimos cuenta", "os disteis cuenta", "se dieron cuenta"] }

        ];

        // --- AUTHENTICATION ---
        function checkAuth() {
            const pass = document.getElementById('auth-pass').value;
            if(pass === 'brobbey') {
                document.getElementById('auth-overlay').style.display = 'none';
            } else {
                document.getElementById('auth-error').style.display = 'block';
            }
        }
        
        // Ensure auth check on Enter key
        document.getElementById('auth-pass').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') checkAuth();
        });

        // --- 2. GLOBAL STATE ---
        let state = {
            mode: null,
            score: 0,
            target: null, 
            gameInterval: null, 
            fallingPos: 0,
            lastPIndex: -1 
        };

        // --- 3. THEME LOGIC ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            updateIcon();
        }

        function updateIcon() {
            const icon = document.getElementById('theme-icon');
            const isDark = document.body.classList.contains('dark-mode');
            
            if(isDark){
                // Sun Icon
                icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
            } else {
                // Moon Icon
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
            }
        }
        updateIcon();

        // --- 4. NAVIGATION ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`section-${id}`).classList.add('active');
            document.getElementById(`nav-${id}`).classList.add('active');
            
            if(id === 'study') renderCards();
        }

        // --- 5. STUDY SECTION LOGIC ---
        function renderCards() {
            const container = document.getElementById('cards-container');
            const search = document.getElementById('search-bar').value.toLowerCase();
            container.innerHTML = '';

            const filtered = verbsData.filter(v => v.infinitive.toLowerCase().includes(search));

            filtered.forEach((verb, index) => {
                const uid = `card-${index}`;
                const generateList = (tenseArr) => {
                    return tenseArr.map((conj, i) => `
                        <li>
                            <span class="pronoun">${pronouns[i]}</span>
                            <span style="font-weight:600">${conj}</span>
                        </li>
                    `).join('');
                };

                const html = `
                    <div class="verb-card">
                        <div class="card-header">
                            <h3>${verb.infinitive}</h3>
                            <span>${verb.translation}</span>
                        </div>
                        
                        <div class="card-tabs">
                            <button class="tab-btn active" onclick="switchCardTab('${uid}', 'presente', this)">Presente</button>
                            <button class="tab-btn" onclick="switchCardTab('${uid}', 'perfecto', this)">Perfecto</button>
                            <button class="tab-btn" onclick="switchCardTab('${uid}', 'indefinido', this)">Indefinido</button>
                        </div>

                        <ul id="${uid}-presente" class="conjugation-list active">${generateList(verb.presente)}</ul>
                        <ul id="${uid}-perfecto" class="conjugation-list">${generateList(verb.perfecto)}</ul>
                        <ul id="${uid}-indefinido" class="conjugation-list">${generateList(verb.indefinido)}</ul>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function switchCardTab(uid, tense, btn) {
            const card = btn.closest('.verb-card');
            card.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            card.querySelectorAll('.conjugation-list').forEach(l => l.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(`${uid}-${tense}`).classList.add('active');
        }

        // --- 5.5 ADD VERB LOGIC ---
        function openAddModal() {
            const container = document.getElementById('conjugation-forms');
            container.innerHTML = '';
            
            const tenses = ['presente', 'perfecto', 'indefinido'];
            
            tenses.forEach(tense => {
                let html = `<div class="form-section-title">${tense.charAt(0).toUpperCase() + tense.slice(1)}</div>`;
                html += `<div class="form-grid-6">`;
                
                pronouns.forEach(p => {
                    html += `
                        <div>
                            <label class="form-label" style="font-size:0.75rem">${p}</label>
                            <input type="text" class="form-input new-verb-input" data-tense="${tense}" placeholder="...">
                        </div>
                    `;
                });
                
                html += `</div>`;
                container.innerHTML += html;
            });
            
            document.getElementById('add-verb-modal').style.display = 'flex';
        }

        function closeAddModal() {
            document.getElementById('add-verb-modal').style.display = 'none';
        }

        function saveNewVerb() {
            const inf = document.getElementById('new-infinitive').value.trim();
            const trans = document.getElementById('new-trans').value.trim();
            
            if(!inf || !trans) {
                alert("Por favor, escribe el infinitivo y la traducci√≥n.");
                return;
            }

            const inputs = document.querySelectorAll('.new-verb-input');
            let newVerb = {
                infinitive: inf,
                translation: trans,
                presente: [],
                perfecto: [],
                indefinido: []
            };

            inputs.forEach(inp => {
                const tense = inp.getAttribute('data-tense');
                const val = inp.value.trim() || "---"; // Placeholder if empty
                newVerb[tense].push(val);
            });

            // ADD TO MEMORY DATA
            verbsData.push(newVerb);
            
            showToast("¬°Verbo a√±adido exitosamente!", true);
            closeAddModal();
            renderCards(); // Refresh UI
            
            // Reset inputs
            document.getElementById('new-infinitive').value = "";
            document.getElementById('new-trans').value = "";
        }


        // --- 6. GAME LAUNCHER ---
        function launchGame(mode) {
            state.mode = mode;
            state.score = 0;
            state.lastPIndex = -1; // Reset memory
            document.getElementById('score').innerText = "0";
            
            document.getElementById('game-menu').style.display = 'none';
            document.getElementById('game-viewport').style.display = 'flex';
            
            const titleEl = document.getElementById('game-title');
            if(mode === 'chat') titleEl.style.color = 'var(--c-chat)';
            if(mode === 'lego') titleEl.style.color = 'var(--c-lego)';
            if(mode === 'teacher') titleEl.style.color = 'var(--c-teacher)';
            if(mode === 'speed') titleEl.style.color = 'var(--c-speed)';
            
            document.getElementById('game-controls').style.display = 'block';
            nextRound();
        }

        function exitGame() {
            clearInterval(state.gameInterval);
            document.getElementById('game-viewport').style.display = 'none';
            document.getElementById('game-menu').style.display = 'grid';
        }

        // --- 7. ROUND GENERATOR ---
        function nextRound() {
            const container = document.getElementById('game-content');
            const input = document.getElementById('user-input');
            container.innerHTML = '';
            input.value = '';
            input.focus();

            // 1. Random Verb
            const vIndex = Math.floor(Math.random() * verbsData.length);
            
            // 2. FORCE NEW SUBJECT (Prevent repetition)
            let pIndex;
            do {
                pIndex = Math.floor(Math.random() * 6);
            } while (pIndex === state.lastPIndex); // Keep picking until different
            state.lastPIndex = pIndex;

            const verbObj = verbsData[vIndex];
            
            // 3. Random Tense
            const tenses = ['presente', 'perfecto', 'indefinido'];
            const selectedTense = tenses[Math.floor(Math.random() * tenses.length)];
            
            const answer = verbObj[selectedTense][pIndex];
            
            state.target = {
                verb: verbObj.infinitive,
                translation: verbObj.translation,
                pronoun: pronouns[pIndex],
                tense: selectedTense, 
                answer: answer,
                displayAnswer: answer 
            };

            if(state.mode === 'chat') setupChat(container);
            else if(state.mode === 'lego') setupLego(container);
            else if(state.mode === 'teacher') setupTeacher(container);
            else if(state.mode === 'speed') setupSpeed(container);
        }

        // --- MODE 1: CHAT ---
        function setupChat(container) {
            let timeContext = "Ahora";
            let tenseDisplay = "Presente";
            
            if(state.target.tense === 'perfecto') {
                timeContext = "Esta ma√±ana";
                tenseDisplay = "Pret√©rito Perfecto";
            } else if(state.target.tense === 'indefinido') {
                timeContext = "Ayer";
                tenseDisplay = "Pret√©rito Indefinido";
            }

            container.innerHTML = `
                <div class="chat-wrapper">
                    <div class="chat-bubble bot-bubble">
                        <div class="chat-meta">Bot ‚Ä¢ ${tenseDisplay}</div>
                        Hola. Necesito ayuda con el verbo <b>${state.target.verb}</b>.
                        <br><br>
                        ¬øC√≥mo se dice: <b>${state.target.pronoun} ...</b>?
                        <div style="margin-top:5px; font-size:0.85rem; opacity:0.8">Contexto: ${timeContext}</div>
                    </div>
                </div>
            `;
        }

        // --- MODE 2: LEGO ---
        function setupLego(container) {
            document.getElementById('game-controls').style.display = 'none'; 
            
            const ans = state.target.answer;
            let stem, suffix;
            
            if(ans.includes(" ")) {
                const parts = ans.split(" ");
                stem = parts[0]; 
                suffix = parts[1]; 
            } else {
                const cut = ans.length > 3 ? 2 : 1;
                stem = ans.slice(0, -cut);
                suffix = ans.slice(-cut);
            }

            const wrongSuffixes = ["-as", "-ido", "-amos", "-ste", "-o", "-ron"].filter(x => x !== "-"+suffix).slice(0, 3);
            const options = [suffix, ...wrongSuffixes.map(w => w.replace("-",""))].sort(() => Math.random() - 0.5);

            container.innerHTML = `
                <div style="text-align:center">
                    <h3 style="color:var(--text-sec); text-transform:uppercase; margin-bottom:5px">${state.target.tense}</h3>
                    <div class="lego-pronoun">${state.target.pronoun}</div>

                    <div class="lego-workspace">
                        <div class="lego-stem">${stem}</div>
                        <div class="lego-dropzone" id="lego-target">?</div>
                    </div>
                    <div class="lego-pieces">
                        ${options.map(opt => `<div class="lego-piece" onclick="solveLego('${stem}', '${opt}')">${opt}</div>`).join('')}
                    </div>
                    
                    <div id="lego-phase2" style="display:none; margin-top:20px; animation:fadeIn 0.5s">
                        <p style="color:var(--text-main); margin-bottom:10px">¬°Correcto! Ahora escribe la palabra completa:</p>
                        <input type="text" id="lego-full-input" class="game-input" placeholder="Escribe ${ans}...">
                        <button class="btn-submit" onclick="checkLegoFull('${ans}')">Verificar</button>
                    </div>
                </div>
            `;
        }

        function solveLego(stem, choice) {
            const attempt = stem + choice;
            const attemptCompound = stem + " " + choice;
            
            if(attempt === state.target.answer || attemptCompound === state.target.answer) {
                document.getElementById('lego-target').innerText = choice;
                document.getElementById('lego-target').classList.add('filled');
                document.querySelector('.lego-pieces').style.display = 'none';
                
                document.getElementById('lego-phase2').style.display = 'block';
                document.getElementById('lego-full-input').focus();
            } else {
                showToast("¬°Incorrecto!", false);
            }
        }

        function checkLegoFull(correct) {
            const val = document.getElementById('lego-full-input').value.trim().toLowerCase();
            if(val === correct.toLowerCase()) handleWin();
            else showToast("¬°Error ortogr√°fico!", false);
        }

        // --- MODE 3: TEACHER (Yellow Note UI) ---
        function setupTeacher(container) {
            let timeLabel = "AHORA";
            if(state.target.tense === 'perfecto') timeLabel = "ESTA MA√ëANA";
            if(state.target.tense === 'indefinido') timeLabel = "AYER";

            container.innerHTML = `
                <div class="teacher-card">
                    <div class="teacher-header">
                        <span class="teacher-label">CONTEXTO: ${timeLabel}</span>
                        <span class="teacher-label">SUJETO: ${state.target.pronoun.toUpperCase()}</span>
                    </div>
                    
                    <div class="teacher-mistake">
                        El estudiante escribi√≥: <br>
                        "${state.target.pronoun} <span class="error-highlight">${state.target.verb.toLowerCase()}</span>..."
                    </div>
                    
                    <div class="teacher-prompt">
                        Correcci√≥n necesaria (${state.target.tense}):
                    </div>
                </div>
            `;
        }

        // --- MODE 4: SPEED ---
        function setupSpeed(container) {
            container.innerHTML = `
                <div class="speed-track">
                    <div class="ground-line"></div>
                </div>
            `;
            
            const fallingEl = document.createElement('div');
            fallingEl.className = 'falling-item';
            fallingEl.innerHTML = `
                <div style="font-size:0.75rem; text-transform:uppercase; color:var(--c-speed); font-weight:900">${state.target.tense}</div>
                <div>${state.target.pronoun} + ${state.target.verb}</div>
            `;
            
            document.querySelector('.speed-track').appendChild(fallingEl);

            let pos = 0;
            let speed = 0.15; 
            
            clearInterval(state.gameInterval);
            state.gameInterval = setInterval(() => {
                pos += speed;
                fallingEl.style.top = pos + '%';
                
                if(pos > 90) { 
                    clearInterval(state.gameInterval);
                    showToast(`¬°Tarde! Era: ${state.target.answer}`, false);
                    document.getElementById('user-input').value = state.target.answer; 
                    setTimeout(nextRound, 2500);
                }
            }, 20);
        }

        // --- SHARED CHECK LOGIC ---
        function checkAnswer() {
            const input = document.getElementById('user-input');
            const val = input.value.trim().toLowerCase();
            const correct = state.target.answer.toLowerCase();

            if(val === correct) {
                handleWin();
            } else {
                showToast("Incorrecto. Intenta de nuevo.", false);
                input.style.borderColor = 'red';
                setTimeout(() => input.style.borderColor = 'var(--border-color)', 500);
            }
        }

        function handleWin() {
            clearInterval(state.gameInterval);
            showToast("¬°Correcto!", true);
            state.score += 10;
            document.getElementById('score').innerText = state.score;
            
            if(state.mode === 'chat') {
                const wrapper = document.querySelector('.chat-wrapper');
                wrapper.innerHTML += `<div class="chat-bubble user-bubble">${document.getElementById('user-input').value}</div>`;
            }

            setTimeout(nextRound, 1200);
        }

        function showToast(msg, isSuccess) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = isSuccess ? 'toast show' : 'toast show error';
            setTimeout(() => t.className = 'toast', 2000);
        }

        document.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                if(state.mode === 'lego') {
                     if(document.getElementById('lego-phase2') && document.getElementById('lego-phase2').style.display === 'block') {
                         checkLegoFull(state.target.answer);
                     }
                } else if (state.mode) {
                    checkAnswer();
                }
            }
        });

        renderCards();

    </script>
</body>
</html>